<!doctype html>

<html lang="en">
<head>
    <title>FootTracker MapApp</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.0.3/dist/leaflet.css"
    integrity="sha512-07I2e+7D8p6he1SIM+1twR5TIrhUQn9+I6yjqD53JQjFiMf8EtC93ty0/5vJTZGF8aAocvHYNEDJajGdNx1IsQ=="
    crossorigin=""/>

    <link rel="stylesheet" type="text/css" href="http://cdnjs.cloudflare.com/ajax/libs/leaflet.markercluster/0.4.0/MarkerCluster.css" />
    <link rel="stylesheet" type="text/css" href="http://cdnjs.cloudflare.com/ajax/libs/leaflet.markercluster/0.4.0/MarkerCluster.Default.css" />

    <script src="https://unpkg.com/leaflet@1.0.3/dist/leaflet.js"
    integrity="sha512-A7vV8IFfih/D732iSSKi20u/ooOfj/AGehOKq0f4vLT1Zr2Y+RX7C+w8A1gaSasGtRUZpF/NZgzSAu4/Gc41Lg=="
    crossorigin=""></script>

    <script src="//cdnjs.cloudflare.com/ajax/libs/leaflet.markercluster/0.4.0/leaflet.markercluster.js"></script>
    
    <!-- Bootstrap core CSS -->
    <link href="/css/bootstrap.min.css" rel="stylesheet">    

</head>

<body>
    <!-- # Menubar: Menubar on the top -->
    <div class="row">
    <nav class="navbar navbar-inverse">
      <div class="container-fluid">
        <div class="navbar-header">
          <a class="navbar-brand" href="#"> FootTracker</a>
        </div>
        <ul class="nav navbar-nav">
          <li class="active"><a href="#">Home</a></li>
        </ul>
        <form id="searchID" class="navbar-form navbar-left">
          <div class="input-group">
            <input type="text" class="form-control" placeholder="Find restaurants, hotels, etc." id="search-input" name="search[term]">
            <div class="input-group-btn">
              <button class="btn btn-default" type="submit">
                <i class="glyphicon glyphicon-search"></i>
              </button>
            </div>
          </div>
        </form>
        <form id="searchID" class="navbar-form navbar-left">
          <div class="input-group">
            <input type="text" class="form-control" id="location-search" name="search[term]" value="San Diego, CA" />
            <div class="input-group-btn">
              <button class="btn btn-default" type="submit">
                <i class="glyphicon glyphicon-search"></i>
              </button>
            </div>
          </div>

        </form>
        <button id="btn_current" class="btn btn-default" style="display: block; width: 100%;" value="gray">Current Location</button>
      </div>
    </nav>
    </div> <!-- End of menu on the top -->
    
    <div class="row">
        <!-- # Menubar: Menubar on the left -->
        <div class="col-md-2">
           <button id="btn_restaurants" class="btn btn-success" style="display: block; width: 100%;" value="color">Restaurants</button>
           <button id="btn_hotels" class="btn btn-success" style="display: block; width: 100%;" value="color">Hotels</button>
           <button id="btn_beach" class="btn btn-success" style="display: block; width: 100%;" value="color">Beach</button>
           <button id="btn_all" class="btn btn-alert" style="display: block; width: 100%;" value="color">All</button>
           <button id="btn_redcircles" class="btn btn-default" style="display: block; width: 100%;" value="color">Red Circles</button>
           <button id="btn_orangecircles" class="btn btn-default" style="display: block; width: 100%;" value="color">Orange Circles</button>
           <button id="btn_yellowcircles" class="btn btn-default" style="display: block; width: 100%;" value="color">Yellow Circles</button>
           <button id="btn_markers" class="btn btn-default" style="display: block; width: 100%;" value="gray">Markers</button>
        </div>
        
        <!-- # Map: Main map part -->
        <div class="col-md-10">
            <div id="mapid" style="height:500px"></div>
            
            <div class="panel panel-success">
              <div class="panel-heading">Places in area</div>
              <div class="panel-body">
                <table class="table table-hover"><thead>
                    <tr>
                      <th>Place</th>
                      <th>Review Count</th>
                      <th>Rating</th>
                      <th>Price</th>
                    </tr>
                  </thead>
                  <tbody id="panel_info">
                    
                  </tbody>
                </table>
              </div>
            </div>
        </div>
    </div>
	<div id="mapCtrl"></div>
    
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCa5u0jiFE4DNOxTMh8iTB-JHumUeZHomU&libraries=places&callback=initAutocomplete" async defer></script>
    
    <!-- Bootstrap core JavaScript
    ================================================== -->
    <!-- Placed at the end of the document so the pages load faster -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>
   
    <script
  src="https://code.jquery.com/jquery-3.2.1.min.js"
  integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4="
  crossorigin="anonymous"></script>
  <script>
  $( "#searchID" ).submit(function( event ) {
    event.preventDefault();
    $.post("/test", $("#searchID").serialize(), yelpSearchSuccess);
  });



  function yelpSearchSuccess(result){
    //You can get businesses which is returned as an array in this json format
    /*
      "businesses": [
    {
      "rating": 4,
      "price": "$",
      "phone": "+14152520800",
      "id": "four-barrel-coffee-san-francisco",
      "is_closed": false,
      "categories": [
        {
          "alias": "coffee",
          "title": "Coffee & Tea"
        }
      ],
      "review_count": 1738,
      "name": "Four Barrel Coffee",
      "url": "https://www.yelp.com/biz/four-barrel-coffee-san-francisco",
      "coordinates": {
        "latitude": 37.7670169511878,
        "longitude": -122.42184275
      },
      "image_url": "http://s3-media2.fl.yelpcdn.com/bphoto/MmgtASP3l_t4tPCL1iAsCg/o.jpg",
      "location": {
        "city": "San Francisco",
        "country": "US",
        "address2": "",
        "address3": "",
        "state": "CA",
        "address1": "375 Valencia St",
        "zip_code": "94103"
      },
      "distance": 1604.23,
      "transactions": ["pickup", "delivery"]
    },
    // ...
  ],


  Typically you can retrieve it after you stringify it then parse it as shown below.
  then they give you an array of businesses

  You can iterate through the array and reference them through dot notation as shown below
  */
    console.log("successful search Callback entering extraction");
    var strResult = JSON.stringify(result.businesses);
    var javaObject = JSON.parse(strResult);
    console.log(javaObject[0].review_count);
    placeMarkers(javaObject);
  }

  /* Array to store search result */
  var places = new Array;

  /* Markers to be displayed on the map */
  var markers_on_map = new L.layerGroup();

  function placeMarkers(businesses) {

    markers_on_map.clearLayers();

    console.log("given businesses: " + businesses);
    document.getElementById("panel_info").innerHTML = "";
    for(var i = 0; i < businesses.length; i++) {
      //console.log("--------------------------------------");
      //console.log("given coordinates are: "+ businesses[i].coordinates);
      //console.log("Pin " + i + " was placed");
      //console.log("given categories are: "+ businesses[i].categories);
      // var marker = L.marker([businesses[i].coordinates.latitude, businesses[i].coordinates.longitude]).bindPopup(businesses[i].name + businesses[i].rating).addTo(mymap);

      var marker = L.marker([businesses[i].coordinates.latitude, businesses[i].coordinates.longitude]).bindPopup(
        "<b>Place</b><br/>" + 
        businesses[i].name + businesses[i].rating + "<br/>Id" +i).addTo(markers_on_map);


        places[i] = businesses[i];
        /* Show informations to info panel on the bottom */
        document.getElementById("panel_info").innerHTML += 
        "<tr id='panel_info'><td>" + places[i].name + "</td><td>" + places[i].review_count + "</td><td>" + places[i].rating + "</td><td>" + places[i].price + "</td></tr>";
    }

    markers_on_map.addTo(mymap);
  }



  
  </script>
    <script src = "/js/map.js"></script>
    <script src="/js/bootstrap.min.js"></script>
    
</body>

</html>